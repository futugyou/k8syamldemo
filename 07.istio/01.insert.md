### this document is from istio book, ENV: aws ec2 Amazon Linux 2 AMI
1. docker
```
sudo yum install -y docker
sudo service docker start
sudo usermod -a -G docker ec2-user
```

2. insert kubectl 
```
curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
sudo install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl
```

3. insert minikube
```
curl -Lo minikube https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64 && chmod +x minikube
sudo mkdir -p /usr/local/bin/
sudo install minikube /usr/local/bin/
minikube start
```

4.  insert istio
```
curl -L https://istio.io/downloadIstio | sh -
vi /etc/profile
export PATH=$PATH:/home/ec2-user/istio-1.16.2/bin

istioctl install --set profile=demo -y 
kubectl get svc -n istio-system
kubectl get pod -n istio-system

```

5. istio demo
```
kubectl label namespace default istio-injection=enabled
kubectl apply -f istio-1.16.2/samples/bookinfo/platform/kube/bookinfo.yaml

// 测试应用部署成功并可正常访问
 kubectl exec -it $(kubectl get pod -l app=ratings -o jsonpath='{.items[0].metadata.name}') -c ratings -- curl productpage:9080/productpage | grep -o "<title>.*</title>"

// sidecar injector
 kubectl get mutatingwebhookconfiguration
```

6. istio ingress
```
kubectl apply -f istio-1.16.2/samples/bookinfo/networking/bookinfo-gateway.yaml
kubectl get gateway

export INGRESS_PORT=$(kubectl -n istio-system get service istio-ingressgateway -o jsonpath='{.spec.ports[?(@.name=="http2")].nodePort}')
export SECURE_INGRESS_PORT=$(kubectl -n istio-system get service istio-ingressgateway -o jsonpath='{.spec.ports[?(@.name=="https")].nodePort}')
export INGRESS_HOST=127.0.0.1
export GATEWAY_URL=$INGRESS_HOST:$INGRESS_PORT
```

7. istio upgrade
```
// upgrade controller plane
istioctl install --set revision=canary

// upgrade data  plane
kubectl label namespace default istio-injection- istio.io/rev=canary
kubectl rollout restart deployment -n default 

//check 
kebectl get pod -l istio.io/rev=canary
istioctl proxy-config endpoints &{PODNAME}.default --cluster xds-grpc -o json | grep hostname

// hot upgrade, need 'rollout'
istioctl upgrade
```

8. istio egress
```
// check if egress enable
kubectl get pod -l istio=egressgateway -n istio-system
// add egress
istioctl manifest apply --set values.global.istioNamespace=istio-system --set values.gateways.istio-egressgateway.enabled=true
```

9. service entry(but i can not found mode in this configmap)
```
// view
kubectl get configmap istio -n istio-system -o yaml | grep -o "mode: ALLOW_ANY"
// update
kubectl get configmap istio -n istio-system -o yaml | sed 's/mode: REGISTRY_ONLY/mode: ALLOW_ANY/g' | kubectl replace -n istio-system -f -
```